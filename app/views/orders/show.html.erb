<%= provide(:title, "HRC Order for #{@order.first_name} #{@order.last_name}") %>

<div class="row">
  <div class="col-md-12">
    <h1>Order for <%= @order.first_name %> <%= @order.last_name %> <span class="float-right"><small><%= @order.email %></small></span></h1>
    <% if user_signed_in? %>
      <div class="card">
        <div class="card-body">
          <h4 class="card-title">Order Status</h4>
          Finalized: <b><%= @order.confirmed? ? 'Yes' : 'No' %> <br></b>
          Fulfilled: <b><%= @order.fulfilled? ? 'Yes (order cannot be modified unless marked un-fulfilled)' : 'No' %></b>
        </div>
      </div>
    <% else %>
      <% if @order.confirmed? %>
        <% if @order.fulfilled %>
          <div class="alert alert-success">
            Your order has been fulfilled! Thanks for supporting Husky Running Club!
          </div>
        <% else %>
          <div class="alert alert-success">
            Your order has been finalized! Please bring payment via cash, check, or by sending the grand total amount to <b>@huskyrunningclub</b> on Venmo.
            <br>
            Once you make a payment, the amount should be updated here within a day or so. You can check the status of this order by visiting this link.
            <br>
            We will let you know once gear orders arrive!
          </div>
        <% end %>
      <% elsif @order.gear_sale.open? %>
        <div class="alert alert-info">
          Add items to your order by clicking the "Add Item To Order" link below. Once you're done adding items, click "Finalize Order."
          <br>
          If you haven't made up your mind yet, you can return to this page anytime by <%= link_to 'bookmarking it', @order %>.
        </div>
      <% else %>
        <div class="alert alert-warning">
          Unfortunately, gear orders are now closed for this sale. If you are still interested in ordering gear, please
          contact us directly as soon as possible, and we may be able to accommodate your order.
        </div>
      <% end %>
    <% end %>
    <table class="table">
      <thead>
      <tr>
        <th style="width: 100px;">Price</th>
        <th>Item</th>
        <th>Size</th>
        <th>Total Price</th>
        <% unless @order.confirmed? %>
          <th>Actions</th>
        <% end %>
      </tr>
      </thead>
      <% unavailable_items = false %>
      <% @order.purchases.each do |p| %>
        <% available = p.item.sizes.include?(p.size); unavailable_items ||= !available %>
        <tr<% unless available %> class='table-warning font-weight-light'<% end %>>
          <td><%= number_to_currency p.item.price %></td>
          <td><%= p.item.name %></td>
          <td><%= p.size.size %><% unless p.item.sizes.include?(p.size) %><span class="text-danger font-weight-bold"> **</span><% end %></td>
          <td><%= number_to_currency(p.item.price) %></td>
          <% unless @order.confirmed? %>
            <td>
              <%= link_to 'Remove', order_purchase_path(p.order, p), method: :delete, 'data-confirm': 'Are you sure?' %>
            </td>
          <% end %>
        </tr>
      <% end %>
      <% if @order.purchases.size == 0 %>
        <tr>
          <td colspan="6">
            <p><em>Nothing here yet! Click "Add Item To Order" to add something.</em></p>
          </td>
        </tr>
      <% end %>
      </tbody>
    </table>

    <% if unavailable_items %>
      <p>
        <span class="text-danger"><b>**</b></span> <b>NB:</b> This item is currently unavailable in this size.
        Your order total will not include the price of this item. If you still wish to purchase this item, please remove
        it and select a new size. Let an officer know if you have and questions!
      </p>
    <% end %>

  </div>
</div>
<div class="row mb-5">
  <div class="col">
    <div class="card border-success">
      <div class="card-body">
        <h5 class="card-title mb-0">Order Actions</h5>
      </div>
      <ul class="list-group list-group-flush">
        <% unless @order.confirmed? %>
          <li class="list-group-item">
            <%= link_to 'Add Item To Order', orders_new_purchase_path(@order) %>
          </li>
          <li class="list-group-item">
            <%= link_to 'Change Name and Email', edit_order_path(@order) %>
          </li>
          <li class="list-group-item">
            <p class="mb-1">
              <%= link_to 'Finalize Order', toggle_finalized_path(@order), method: :patch, 'data-confirm': 'Once you finalize this order, you will be unable to change it. Are you sure?'%>
            </p>
            <% unless user_signed_in? %>
              <small>You won't be able to make changes to your order once it's finalized.</small>
            <% end %>
          </li>
        <% end %>

        <% if @order.confirmed? && user_signed_in? && !@order.fulfilled? %>
          <%= link_to 'Un-Finalize Order', toggle_finalized_path(@order), method: :patch, class: 'list-group-item list-group-item-action list-group-item-warning' %>
        <% end %>

        <% if @order.confirmed? && !user_signed_in? %>
          <div class="card-body">
            <i>You're all set! We'll make an announcement when gear orders arrive. Please make sure you've paid for your order.</i>
          </div>
        <% end %>
      </ul>
    </div>
    <% if user_signed_in? %>
      <%= link_to 'Back To Orders', orders_path, class: 'btn btn-link' %>
    <% end %>
  </div>

  <div class="col">
    <div class="card bg-light border-primary">
      <div class="card-body">
        <h4 class="card-title">Payment History</h4>
        <p>Payments can be made via cash, check, or Venmo to: <b>@huskyrunningclub</b>.</p>
        <table class="table table-sm">
          <thead>
          <tr>
            <th>Date</th>
            <th>Amount</th>
            <th>Method</th>
            <% if user_signed_in? && !@order.fulfilled? %>
              <th>Actions</th>
            <% end %>
          </tr>
          </thead>
          <tbody>
          <% @order.payments.each do |p| %>
            <tr>
              <td><%= p.created_at.strftime('%B %d, %Y') %></td>
              <td><%= number_to_currency p.amount %></td>
              <td><%= p.method.humanize %></td>
              <% if user_signed_in? && !@order.fulfilled? %>
                <td><%= link_to 'Delete', order_payment_path(@order, p), method: :delete, 'data-confirm': 'Are you sure you want to delete this payment?' %></td>
              <% end %>
            </tr>
          <% end %>
          <% if @order.payments.size == 0 %>
            <td colspan="4"><em>Nothing here yet! Payments will be reflected within a few days of receipt.</em></td>
          <% end %>
          </tbody>
        </table>
        <h5>Grand total: <%= number_to_currency @order.total %></h5>
        <h6>Amount due: <%= number_to_currency @order.total - @order.amount_paid %></h6>
      </div>
      <% if user_signed_in? %>
        <div class="card-footer">
          <p>Add Payment</p>
          <%= form_with model: @order.payments.build, url: order_payments_path(@order.id), local: true, html: {class: 'form-inline'} do |f| %>
            <%= f.label :amount, class: 'sr-only' %>

            <div class="input-group">
              <div class="input-group-prepend"><span class="input-group-text">$</span></div>
              <%= f.number_field :amount, placeholder: 'Amount', step: 0.01, class: 'form-control', id: 'payment_amount', style: 'width: 150px;' %>
              <div class="input-group-append">
                <%= f.select :method, options_for_select([["Method", ""]] + Payment.methods.keys.map {|x| [x.humanize, x]}), {}, class: 'custom-select mr-2', style: 'border-top-left-radius: 0px;border-bottom-left-radius: 0px;' %>
              </div>
            </div>

            <div class="input-group">
              <%= f.submit class: 'btn btn-primary' %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>


